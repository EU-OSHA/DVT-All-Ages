define(function(require){"use strict";function nextId(){return sequence++}function ZylkBarChartDirective(dataService,$log,plotsProvider,exportService,dvtUtils,maximize){var _template='<div class="col-md-12 dvt-chart pyramid"><div data-ng-if="!isMaximized"><div  class="contextual-menu cursor-pointer maximizeImage" data-ng-class="showContextuals?\'\':\'hidden\'">';return _template+='<div class="dropdown"><button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true"><i class="three-points-vertical" title="Export"></i></button><ul class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenu1"><li data-ng-repeat="item in items"><a data-ng-click="open(item.action)" role="button" data-ng-bind="item.text"></a></li></ul></div>',_template+='</div><div class="col-xs-12"><div class="containerPyramid"><div class="title padded-left" data-ng-bind-html="title"></div><div ng-attr-id="{{ id }}"></div><div ng-if="!home" class="pyramidYears">Solid Colour <span class="mr">2014 </span>Bordered <span>2060 </span></div><div class="logoGraphics-wrapper"><img alt="European Agency for Safety and Health at Work" src="/pentaho/plugin/pentaho-cdf-dd/api/resources/system/all-ages/static/custom/img/EU-OSHA-en.png" class="logoGraphics"></div><div class="functionalLegend" data-ng-bind-html="functionalLegend"></div></div></div></div><div data-ng-if="isMaximized" class="zylk-bar-chart"><div class="row"><div class="header col-md-12 nopadding"><div class="col-xs-11 col-sm-11 col-md-11 text-left wrapper-title-graphic"><h3 class="title" data-ng-bind-html="title"></h3></div><div class="col-md-1 pull-right nopadding wrapper-contextual-menu"><div class="pull-right contextual-menu">',_template+='<div class="dropdown"><button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true"><i class="three-points-vertical" title="Export"></i></button><ul class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenu1"><li data-ng-repeat="item in items"><a data-ng-click="open(item.action)" role="button" data-ng-bind="item.text"></a></li></ul></div>',_template+='</div></div></div><div class="backGraps"><div data-ng-attr-id="{{ id }}"></div><div ng-if="!home" class="pyramidYears">Solid Colour <span class="mr">2014 </span>Bordered <span>2060 </span></div></div><div class="logoGraphics-wrapper"><img alt="European Agency for Safety and Health at Work" src="/pentaho/plugin/pentaho-cdf-dd/api/resources/system/all-ages/static/custom/img/EU-OSHA-trans-en.png" class="logoGraphics"></div><div class="functionalLegend" data-ng-bind-html="functionalLegend"></div></div>',{restrict:"E",require:["^zylkDashboard"],replace:!0,priority:-1,scope:{listenTo:"=",params:"=",postFetch:"=",clickAction:"=",colors:"=",colors2:"=",contextuals:"=?",colorMap:"=",color2AxisMap:"=",home:"=",isMaximized:"="},template:_template,link:function(scope,element,attributes,controllers){attributes.id.split("_").length>1&&(attributes.id=attributes.id.split("_")[1]),scope.id="zylk_pyramid_"+nextId();var dashboard=controllers[0];scope.divClass="pyramid",scope.isZoom=!!attributes.isZoom;var definition={type:"cccBarChart",name:scope.id,executeAtStart:!0,priority:attributes.priority||5,htmlObject:scope.id,listeners:[],parameters:[],lifecycle:{silent:!0},chartDefinition:{dataAccessId:attributes.query||"getPyramidDataWhitYear",path:attributes.cda||dvtUtils.setCDAIn(),width:attributes.width||100,height:attributes.height||100,orthoAxisFixedMin:-6,orthoAxisFixedMax:6,orientation:attributes.orientation||"horizontal",crosstabMode:attributes.cross||!1,stacked:attributes.stacked||1,axisLabel_font:attributes.axisLabel_font||'normal 12px "Open Sans"',axisTitleLabel_font:'normal 12px "Open Sans"',axisTitleLabel_textStyle:"gray",clickable:!1,clickAction:function(dataset){},orthoAxisTickFormatter:scope.orthoFormatter||function(value,precision,index){return Math.abs(value)},calculations:scope.calculations||[{names:"dataPart",calculation:function(datum,out){var year=datum.atoms.category2.value;scope.home?out.dataPart=year<0?"0":"1":out.dataPart=2060==year?"0":"1"}}],plots:scope.plots||[{name:"main",dataPart:"1",barSizeMax:attributes.secondBarSize||15,bar_fillStyle:function(dataset){return"Female"===dataset.atoms.series.value?this.finished(scope.colors[1]):this.finished(scope.colors[0])},bar_lineWidth:function(dataset){return this.finished(2.5)},visualRoles:{series:"series",category:"category"},colorAxis:1},{type:"bar",dataPart:"0",stacked:!0,barSizeMax:attributes.mainBarSize||3,bar_strokeStyle:function(dataset){return dataset.atoms.series.value,this.finished(scope.colors[2])},bar_lineWidth:function(dataset){return this.finished(2)},visualRoles:{series:"series",category:"category"},colorAxis:2}],colorRole:attributes.colorRole||"series",colors:scope.colors||["cadetblue","darkgray"],colorAxisColors:scope.colors||["cadetblue","darkgray"],color2AxisColors:scope.colors2||["white"],colorAxisTransform:function(color){return color},color2AxisTransform:function(color){return color.opacity=0,color.darker(.05)},colorMap:scope.colorMap||{},color2AxisMap:scope.color2AxisMap||{},legend:attributes.legend||!1,legendAlign:"center",legendFont:attributes.legendFont||'normal 12px "Open Sans"',legendShape:"circle",legendClickMode:attributes.legendClickMode||"none",color2AxisLegendShape:"diamond",color2AxisLegendVisible:attributes.legend2||!1,animate:attributes.animate||!0,selectable:attributes.selectable||!1,hoverable:attributes.hover||!1,tooltipClassName:"light",tooltipOpacity:.75,groupedLabelSep:":",legendItemPadding:5,baseAxisTitle:"Age group",baseAxisTitleMargins:10,orthoAxisTitle:attributes.orthoAxisTitle||"Percentage of population",orthoAxisTitleMargins:10,baseAxisOffset:.03,orthoAxisVisible:!0,ortho2AxisVisible:!1,baseAxisVisible:!0,plotFrameVisible:!1,orthoAxisGrid:!1,baseAxisGrid:!0,axisGrid_strokeStyle:"white",axisGrid_lineWidth:2,plotBg_fillStyle:plotsProvider.getPlotBgColor(),plot_add:function(){var maleCountryColour=attributes.maleColour||1,femaleCountryColor=attributes.femaleColour||1,panel=new pv.Panel;return panel.add(pv.Image).url(configService.getImagesPath()+"icons/"+femaleCountryColor+"_female_pyramid.png").height(37).width(37).top(5).right(5),panel.add(pv.Image).url(configService.getImagesPath()+"icons/"+maleCountryColour+"_male_pyramid.png").height(37).width(37).top(5).left(5),panel},tooltipGravity:"sw",format:{number:function(number){return number<0?-1*number:number}},baseAxisTooltipEnabled:!1}};if(scope.home&&(definition.chartDefinition.animate=!1),scope.params?definition.parameters=scope.params:(definition.parameters=[["pCountry1","EU"],["pYears","2014"]],definition.chartDefinition.plots[0].barSizeMax=9),scope.listenTo)for(var listen in scope.listenTo)definition.listeners[listen]=scope.listenTo[listen];if(scope.clickAction&&(definition.chartDefinition.clickable=!0,definition.chartDefinition.clickAction=scope.clickAction),attributes.angle&&(definition.chartDefinition.baseAxisLabel_textAngle=-Math.PI/3,definition.chartDefinition.baseAxisLabel_textAlign="right",definition.chartDefinition.baseAxisLabel_textBaseline="top",definition.chartDefinition.axisBandSizeRatio=.6),scope.postFetch&&(definition.postFetch=scope.postFetch),attributes.pXLabels&&(definition.chartDefinition.xAxisLabel_visible=0!=attributes.pXLabels),attributes.pYLabels&&(definition.chartDefinition.yAxisLabel_visible=0!=attributes.pYLabels),attributes.colorRole)switch(attributes.colorRole){case"s":case"c":definition.chartDefinition.colorRole="series";break;default:definition.chartDefinition.colorRole=attributes.colorRole}if(attributes.orthoaxistitle&&(definition.chartDefinition.orthoAxisTitle=attributes.orthoAxisTitle),!scope.contextuals||scope.contextuals.length>0){scope.contextuals||(scope.contextuals=[]),attributes.isMaximized||scope.contextuals.push(["Maximize","maximize"]);window.navigator.userAgent.indexOf("MSIE ")>0||navigator.userAgent.match(/Trident.*rv\:11\./)?[["Download raw data","exportData"]].forEach(function(item){scope.contextuals.push(item)}):[["Export as image","exportImage"],["Download raw data","exportData"]].forEach(configService.isMobile()?function(item){scope.contextuals.push(item)}:function(item){scope.contextuals.push(item)})}scope.showContextuals=scope.contextuals&&scope.contextuals.length>0||!1,scope.showContextuals&&(scope.items=[],scope.contextuals.forEach(function(item){scope.items.push({text:item[0],action:item[1]})})),attributes.id&&(definition.chartDefinition.title=null,dataService.getIndicatorMetadata(attributes.id).then(function(dataset){$log.debug(dataset),plotsProvider.showContextualData(dataset,definition,scope,attributes)})),definition.maxType=attributes.type,definition.id=attributes.id,definition.title=attributes.title,definition.showLegend=!0,definition.chartType=attributes.type,definition.angle=attributes.angle,definition.cssClass=attributes.cssClass,definition.pyramid=!0,definition.femaleColour=attributes.femaleColour,definition.maleColour=attributes.maleColour,attributes.maxFunctionalLegend&&(definition.maxFunctionalLegend=attributes.maxFunctionalLegend);var dvtModal=maximize.setModal(definition);scope.open=function(action){switch(action){case"enlarge":var scrollTop=$(window).scrollTop();$cookies.remove("scrollTop"),$cookies.put("scrollTop",scrollTop),scope.clickAction();break;case"maximize":maximize.doMaximize(dvtModal,definition,"maximizePyramid","MaximizeController");break;case"exportImage":exportService.exportImageAction(scope);break;case"exportData":exportService.exportDataAction(scope,dashboard)}};var chart=new BarChartComponent(definition);chart.postExecution=function(){scope.postExecution&&scope.postExecution(),this.chart.options.width=this.placeholder().width(),this.chart.render(!0,!0,!1)},dashboard.register(chart)}}}var BarChartComponent=require("cdf/components/CccBarChartComponent"),pv=require("cdf/lib/CCC/protovis"),configService=require("horizontal/config/configService"),sequence=1;return ZylkBarChartDirective.$inject=["dataService","$log","plotsProvider","exportService","dvtUtils","maximize"],ZylkBarChartDirective});