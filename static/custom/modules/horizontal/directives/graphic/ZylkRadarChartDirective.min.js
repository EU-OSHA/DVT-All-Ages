define(function(require){"use strict";function nextId(){return sequence++}function ZylkRadarDirective($q,$log,dvtUtils,plotsProvider,exportService,dataService,maximize){var ua=window.navigator.userAgent,msie=ua.indexOf("MSIE "),template="";return msie>0||navigator.userAgent.match(/Trident.*rv\:11\./)?template='<div class="col-md-12 dvt-chart radar"><div class="col-xs-9 col-sm-10 col-md-11 col-lg-10"><h3 ng-if="(!!title && !isMaximized) || (isMaximized && !longTitle)" class="title" data-ng-bind-html="title"></h3><h3 ng-if="!!isMaximized && !!longTitle" class="title" data-ng-bind-html="longTitle"></h3></div><div class="col-xs-3 col-sm-2 col-md-1 col-lg-2 text-right no-padding"><div data-ng-if="!isMaximized" class="col-xs-3 col-sm-3 col-md-3 col-lg-2 pull-right nopadding contextual-menu cursor-pointer maximizeImage"><div class="dropdown" ng-if="!isEnlarge==true"><button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true"><i class="three-points-vertical" title="Export"></i></button><ul class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenu1"><li data-ng-repeat="item in items"><a data-ng-click="open(item.action)" role="button" data-ng-bind="item.text"></a></li></ul></div></div></div><div class="col-xs-12"><div class="radar"><div ng-attr-id="{{ id }}"></div></div><div class="logoGraphics-wrapper"><img alt="European Agency for Safety and Health at Work" src="/pentaho/plugin/pentaho-cdf-dd/api/resources/system/all-ages/static/custom/img/EU-OSHA-en.png" class="logoGraphics"></div><div class="functionalLegend" data-ng-bind-html="functionalLegend"></div></div></div>':(template='<div class="col-md-12 dvt-chart radar"><div class="col-xs-9 col-sm-10 col-md-11 col-lg-10"><h3 ng-if="(!!title && !isMaximized) || (isMaximized && !longTitle)" class="title" data-ng-bind-html="title"></h3><h3 ng-if="!!isMaximized && !!longTitle" class="title" data-ng-bind-html="longTitle"></h3></div><div class="col-xs-3 col-sm-2 col-md-1 col-lg-2 text-right no-padding"><div data-ng-if="!isMaximized" class="col-xs-3 col-sm-3 col-md-3 col-lg-2 pull-right nopadding contextual-menu cursor-pointer maximizeImage">',template+='<div class="dropdown" ng-if="!isEnlarge==true"><button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true"><i class="three-points-vertical" title="Export"></i></button><ul class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenu1"><li data-ng-repeat="item in items"><a data-ng-click="open(item.action)" role="button" data-ng-bind="item.text"></a></li></ul></div>',template+='</div><div data-ng-if="isMaximized && isZoom" class="contextual-menu">',navigator.userAgent.match("iPad")||(template+='<div class="dropdown" ng-if="!isEnlarge==true"><a data-ng-click="open(\'exportImageLink\')" role="button"><i class="fa fa-picture-o" aria-hidden="true"></i> Export as Image</a></div>'),template+='</div></div><div class="col-xs-12"><div class="radar"><div ng-attr-id="{{ id }}"></div></div><div class="logoGraphics-wrapper"><img alt="European Agency for Safety and Health at Work" src="/pentaho/plugin/pentaho-cdf-dd/api/resources/system/all-ages/static/custom/img/EU-OSHA-en.png" class="logoGraphics"></div><div class="functionalLegend" data-ng-bind-html="functionalLegend"></div></div></div>'),{restrict:"E",require:["^zylkDashboard"],priority:-1,scope:{promises:"=",country1:"=",country2:"=",contextuals:"=?",listenTo:"=",params:"=",clickAction:"="},transclude:!0,template:template,link:function(scope,element,attributes,controllers){attributes.id.split("_").length>1&&(attributes.id=attributes.id.split("_")[1]),scope.id="zylk_radarChart"+nextId(),scope.divClass=attributes.cssClass,scope.isMaximized=!!attributes.isMaximized,scope.longTitle=attributes.longTitle,scope.isHistorical=attributes.historical,scope.isEnlarge=attributes.isEnlarged,scope.isZoom=!!attributes.isZoom;var dashboard=controllers[0],country1=scope.country1,country2=scope.country2,color1=dvtUtils.getColorCountry(1),lightColor1=dvtUtils.getColorCountry(12),color2=dvtUtils.getColorCountry(2),lightColor2=dvtUtils.getColorCountry(22),colorEU=dvtUtils.getEUColor(),lightColorEU=dvtUtils.getEUColor(2),definition={type:"raphaelComponent",name:scope.id,priority:attributes.priority||5,parameters:[],executeAtStart:!0,width:attributes.width||1e3,height:attributes.height||600,htmlObject:scope.id,listeners:[],customfunction:function(){function Radar(paper,cx,cy,r,values,secondIndicatorValues,opts){if(!values||0==values.length)throw"Values array is required";opts=opts||{};var $r=Raphael,angle=360/values.length,defaultOpts={meshSize:30,labels:[],labelFontSize:16,labelColor:"black",valueFontSize:13,drawLabels:!0,drawValues:!0,armFill:"none",armStroke:"rgba(255, 106, 0, .5)",armStrokeWidth:1,drawArms:!0,meshFill:"none",meshStroke:"rgba(120, 120, 120, .5)",meshStrokeWidth:1,drawMesh:!0,max:Math.max.apply(Math,values),pathFill:"none",pathStroke:"#0026ff",pathStrokeWidth:3,pathCircleOuterRadius:4,pathCircleInnerRadius:2,pathCircleStroke:"none",drawPathCircles:!0,closePath:!0,indicators:["indicator1","indicator2"]};for(var prop in opts)defaultOpts[prop]=opts[prop];opts=defaultOpts;var clicked=scope.clickAction,labelvalue=function(cx,cy,r,angle,value,max){var rad=$r.rad(angle),x=cx+r/max*value*Math.cos(rad),y=cy+r/max*value*Math.sin(rad);return Math.round(x)===cx&&(y+=10*Math.sin(rad)),{x:Math.round(x)===cx?x+2:x<cx?x-10:x+10,y:Math.round(y)===cy?y-2:y<cy?y-10:y+10,attr:{"text-anchor":Math.round(x)===cx?"middle":x<cx?"end":"start","font-size":opts.valueFontSize,fill:opts.valuesColor}}},path=function(cx,cy,r,startAngle,values,max,theme){for(var pathData=[],i=0,l=values.length;i<l;){var rad=$r.rad(startAngle+360/values.length*i);pathData.push(0==i?"M":"L"),pathData.push(cx+r/max*values[i]*Math.cos(rad)),pathData.push(cy+r/max*values[i]*Math.sin(rad)),++i}opts.closePath&&pathData.push("Z"),theme?paper.path(pathData.join(",")).attr({stroke:theme.pathStroke,fill:theme.pathFill,"stroke-width":theme.pathStrokeWidth,"stroke-linejoin":"round"}):paper.path(pathData.join(",")).attr({stroke:opts.pathStroke,fill:opts.pathFill,"stroke-width":opts.pathStrokeWidth,"stroke-linejoin":"round"})},circle=function(cx,cy,r,angle,value,max,title,theme){var colorStroke=title==country1&&"EU"!=country1?theme?lightColor1:color1:title==country2&&"EU"!=country2?theme?lightColor2:color2:"EU"==title?theme?lightColorEU:colorEU:theme?theme.pathCircleStroke||opts.pathCircleStroke:opts.pathCircleStroke,rad=$r.rad(angle),p={x:cx+r/max*value*Math.cos(rad),y:cy+r/max*value*Math.sin(rad)},outerRadius=title==country1||title==country2||"EU"==title?6*opts.pathCircleOuterRadius:2*opts.pathCircleOuterRadius;paper.circle(p.x,p.y,outerRadius).attr({fill:colorStroke,stroke:"none",title:title+": "+value}),paper.circle(p.x,p.y,2*opts.pathCircleInnerRadius).attr({fill:"#fff",stroke:"none",title:title+": "+value})},shape=function(x,y,indicator){var color=dvtUtils.getSpiderIndicator(indicator);return paper.circle(x,y,opts.pathCircleOuterRadius).attr({fill:color,stroke:"none"}),paper.path(["m",x,y,"h",25]).attr({stroke:color,"stroke-width":2}),x+=25,paper.circle(x,y,opts.pathCircleOuterRadius).attr({fill:color,stroke:"none"}),x+10};if(opts.drawArms)for(var i=0,l=values.length,lab={};i<l;){lab=opts.labels[i];var armStrokeColor=lab==country1&&"EU"!=country1?color1:lab==country2&&"EU"!=country2?color2:"EU"==lab?colorEU:opts.armStroke,armStrokeWidth=lab==country1||lab==country2||"EU"==lab?2.5:opts.armStrokeWidth,pathAux=paper.path(function(cx,cy,r,angle){var rad=$r.rad(angle);return["M",cx,cy,"L",cx+r*Math.cos(rad),cy+r*Math.sin(rad),"Z"].join(",")}(cx,cy,r,270+angle*i)).attr({fill:opts.armFill,stroke:armStrokeColor,"stroke-width":armStrokeWidth});pathAux.id=lab,pathAux.attr("cursor","pointer"),pathAux.click(clicked),++i}if(opts.drawMesh){for(var meshCount=Math.floor(r/opts.meshSize),meshHeight=r/meshCount,meshRadius=meshHeight,meshes=[];meshCount--;)meshes.push(function(cx,cy,r,startAngle,angle){for(var mesh=["M"],circle=startAngle+360;startAngle<circle;){var x=cx+r*Math.cos($r.rad(startAngle)),y=cy+r*Math.sin($r.rad(startAngle));mesh.push(x),mesh.push(y),mesh.push("L"),startAngle+=angle}return mesh.push("Z"),mesh.join(",")}(cx,cy,meshRadius,270,angle)),meshRadius+=meshHeight;for(var i=0,l=meshes.length;i<l;)paper.path(meshes[i]).attr({fill:opts.meshFill,stroke:opts.meshStroke,"stroke-width":opts.meshStrokeWidth}),++i}if(opts.drawLabels)for(var i=opts.labels.length;i--;){var textObject=function(cx,cy,r,angle){var rad=$r.rad(angle),x=cx+r*Math.cos(rad),y=cy+r*Math.sin(rad);return{x:Math.round(x)===cx?x:x<cx?x-10:x+10,y:Math.round(y)===cy?y:y<cy?y-10:y+10,attr:{"text-anchor":Math.round(x)===cx?"middle":x<cx?"end":"start","font-size":opts.labelFontSize,"font-family":"Open Sans",font:""}}}(cx,cy,r,270+angle*i),fulltext=opts.labels[i],text=paper.text(textObject.x,textObject.y,fulltext).attr(textObject.attr);fulltext=fulltext.replace("-","- ").replace("/","/ ");for(var labelStrokeColor=fulltext==country1&&"EU"!=country1?color1:fulltext==country2&&"EU"!=country2?color2:"EU"==fulltext?colorEU:opts.labelColor,labelSize=fulltext==country1||fulltext==country2||"EU"==fulltext?20:opts.labelFontSize,words=fulltext.split(" "),wordsCount=words.length,maxwidth=Math.min(textObject.x,paper.width-textObject.x),maxheight=Math.min(textObject.y,paper.height-textObject.y),fontSize=labelSize;fontSize>=9;--fontSize){text.attr("font-size",fontSize),text.attr("fill",labelStrokeColor),text.attr("cursor","pointer"),text.attr("font-family","Open Sans"),text.id=fulltext,text.click(clicked),text.hover(function(){$log.debug("hello....."+this.id),this.c=this.c||this.attr("fill"),this.s=this.s||this.attr("font-size"),this.stop().animate({fill:dvtUtils.getColorCountry(1),"font-size":20},200)},function(){$log.debug("bye....."+this.id),$log.debug(this),this.stop().animate({fill:this.c,"font-size":this.s},350)});for(var tempText="",i1=0;i1<wordsCount;++i1)text.attr("text",tempText+" "+words[i1]),text.getBBox().width>maxwidth?tempText+="\n"+words[i1]:tempText+=" "+words[i1];if(text.attr("text",tempText),text.getBBox().width>maxwidth&&(tempText=tempText.replace("-","-\n"),text.attr("text",tempText)),9==fontSize||text.getBBox().height<=maxheight&&(text.getBBox().width<=maxwidth||wordsCount>1)){tempText.split("\n").length;text.attr("text",tempText.substring(1));break}}}if(path(cx,cy,r,270,values,opts.max),opts.drawPathCircles)for(var i=values.length;i--;)circle(cx,cy,r,270+angle*i,values[i],opts.max,opts.labels[i]);if(opts.drawValues)for(var i=values.length;i--;)if(opts.drawAllValues||opts.labels[i]==country1||opts.labels[i]==country2||"EU"==opts.labels[i])var textObject=labelvalue(cx,cy,r,270+angle*i,values[i],opts.max),fulltext=values[i]+opts.valuesFormat,text=paper.text(textObject.x,textObject.y,fulltext).attr(textObject.attr);if(opts.showTechnicalLegend){var x=.4*paper.width-4*opts.indicators[0].length,y=.95*paper.height;!function(x,y){x=shape(x,y,1),paper.text(x,y,opts.indicators[1]).attr({fill:dvtUtils.getSpiderIndicator(1),"text-anchor":"start","font-size":"15px","font-family":"Open Sans",font:""});var length=opts.indicators[1].length;x+=length>10?7*length:10*length,x=shape(x,y,0),paper.text(x,y,opts.indicators[0]).attr({fill:dvtUtils.getSpiderIndicator(0),"text-anchor":"start","font-size":"15px","font-family":"Open Sans",font:""})}(x,y)}if(secondIndicatorValues){var theme={pathStroke:dvtUtils.getSpiderIndicator(1),pathFill:"none",pathStrokeWidth:3,pathCircleStroke:dvtUtils.getSpiderIndicator(1)};if(path(cx,cy,r,270,secondIndicatorValues,opts.max,theme),opts.drawPathCircles)for(var i=secondIndicatorValues.length;i--;)circle(cx,cy,r,270+angle*i,secondIndicatorValues[i],opts.max,opts.labels[i],theme);if(opts.drawValues)for(var i=secondIndicatorValues.length;i--;)if(opts.drawAllValues||opts.labels[i]==country1||opts.labels[i]==country2||"EU"==opts.labels[i])var textObject=labelvalue(cx,cy,r,270+angle*i,secondIndicatorValues[i],opts.max),fulltext=secondIndicatorValues[i]+opts.valuesFormat,text=paper.text(textObject.x,textObject.y,fulltext).attr(textObject.attr)}}Raphael.fn.radar=function(cx,cy,r,values,secondIndicatorValues,opts){return new Radar(this,cx,cy,r,values,secondIndicatorValues,opts)},$q.all(scope.promises).then(function(dataset){var firstIndicatorValues=[],firstIndicatorLabels=[],secondIndicatorValues=[],indicatorNames=[];dataset[0].data.resultset.forEach(function(element,index,array){$log.debug("########################---------\x3e"+element),firstIndicatorLabels.push(element[0]),firstIndicatorValues.push(element[1]),indicatorNames.indexOf(element[2])<0&&indicatorNames.push(element[2])}),dataset[1]&&dataset[1].data.resultset.forEach(function(element,index,array){$log.debug("########################---------\x3e"+element),secondIndicatorValues.push(element[1]),indicatorNames.indexOf(element[2])<0&&indicatorNames.push(element[2])});var paper=Raphael(scope.id,definition.width,definition.height);paper.setViewBox(0,0,definition.width,definition.height);var svg=document.querySelector("#"+scope.id+" svg");svg.removeAttribute("width"),configService.isIE()||configService.isMobile()||svg.removeAttribute("height"),configService.isMobile()&&(svg.removeAttribute("height"),svg.setAttribute("width","100%")),paper.radar(definition.width/2-20,definition.height/2-20,attributes.radio,firstIndicatorValues,secondIndicatorValues,{meshSize:attributes.meshSize||30,labels:firstIndicatorLabels,labelFontSize:13,labelColor:"black",drawLabels:attributes.drawLabels||!0,valuesColor:dvtUtils.getSpiderValuesColor(),valuesFormat:attributes.valuesFormat||"",drawAllValues:!1,armFill:"none",armStroke:"rgba(120, 120, 120, .3)",armStrokeWidth:1,drawArms:!0,meshFill:"none",meshStroke:"rgba(120, 120, 120, .5)",meshStrokeWidth:1,drawMesh:!0,max:attributes.axisFixedMax||100,pathFill:"none",pathStroke:dvtUtils.getSpiderIndicator(0),pathStrokeWidth:3,pathCircleOuterRadius:1.5,pathCircleInnerRadius:0,pathCircleStroke:dvtUtils.getSpiderIndicator(0),drawPathCircles:!0,showTechnicalLegend:!0,indicators:indicatorNames}),paper.canvas.setAttribute("preserveAspectRatio","xMaxYMin")})}};if($log.debug("Link function of "+scope.id),!scope.contextuals||scope.contextuals.length>0){scope.contextuals||(scope.contextuals=[]),0==scope.contextuals.length&&(attributes.isMaximized||scope.contextuals.push(["Maximize","maximize"]));[["Export as image","exportImage"]].forEach(window.navigator.userAgent.indexOf("MSIE ")>0||navigator.userAgent.match(/Trident.*rv\:11\./)?function(item){scope.contextuals.push(item)}:configService.isMobile()?function(item){scope.contextuals.push(item)}:function(item){scope.contextuals.push(item)})}if(scope.showContextuals=scope.contextuals&&scope.contextuals.length>0||!1,scope.showContextuals&&(scope.items=[],scope.contextuals.forEach(function(item,index,array){scope.items.push({text:item[0],action:item[1]})})),attributes.id){JSON.parse("["+attributes.id+"]").forEach(function(id,index,array){$log.debug("METADATA INDICATORS FOREACH----------------------------------\x3e"),$log.debug(id),dataService.getIndicatorMetadata(id).then(function(dataset){$log.debug(dataset),plotsProvider.showContextualData(dataset,definition,scope,attributes)})})}!function(){definition.maxType="radar",definition.title=attributes.title,definition.cssClass=attributes.cssClass,definition.pcountry1=scope.country1,definition.pCountry2=scope.country2,definition.promises=scope.promises,definition.id=attributes.id,definition.max=attributes.axisFixedMax,definition.longTitle=attributes.longTitle,definition.radio=attributes.radio,definition.valuesFormat=attributes.valuesFormat,definition.meshSize=attributes.meshSize||30,attributes.maxFunctionalLegend&&(definition.maxFunctionalLegend=attributes.maxFunctionalLegend)}();var dvtModal=maximize.setModal(definition);scope.open=function(action){if("function"==typeof action)action.call(this);else switch(action){case"enlarge":var scrollTop=$(window).scrollTop();$cookies.remove("scrollTop"),$cookies.put("scrollTop",scrollTop),scope.clickAction();break;case"olderWorkers":break;case"maximize":maximize.doMaximize(dvtModal,definition,"maximizeRadar","MaximizeController",!1);break;case"exportImage":maximize.doMaximize(dvtModal,definition,"maximizeRadar","MaximizeController",!0);break;case"exportData":exportService.exportDataAction(scope,dashboard)}};var chart=new RaphaelComponent(definition);dashboard.register(chart),chart.postExecution=function(){scope.postExecution&&scope.postExecution(),this.width=this.placeholder().width()}}}}var RaphaelComponent=require("cde/components/RaphaelComponent"),configService=require("horizontal/config/configService"),sequence=1;return ZylkRadarDirective.$inject=["$q","$log","dvtUtils","plotsProvider","exportService","dataService","maximize"],ZylkRadarDirective});