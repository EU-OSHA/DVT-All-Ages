define(function(require){var html2canvas=require("common-exporting/html2canvas"),ExportService=function($log,$q,$state){function Utf8Encode(strUni){return String(strUni).replace(/[\u0080-\u07ff]/g,function(c){var cc=c.charCodeAt(0);return String.fromCharCode(192|cc>>6,128|63&cc)}).replace(/[\u0800-\uffff]/g,function(c){var cc=c.charCodeAt(0);return String.fromCharCode(224|cc>>12,128|cc>>6&63,128|63&cc)})}var ExportPopupComponent=require("cde/components/ExportPopupComponent");return require("common-exporting/file-saver"),{exportImageAction:function(scope){scope.$root.hasAgreedCookies&&window._paq.push(["trackEvent",$state.current.name,"Export","Image"]);var node=$("#"+scope.id).parents(".dvt-chart")[0],svg=document.querySelector(".modal svg"),xml=Utf8Encode((new XMLSerializer).serializeToString(svg)),svg64=btoa(xml),image64="data:image/svg+xml;base64,"+svg64;angular.element(".modal svg").after("<img id='svg2image'>"),document.getElementById("svg2image").src=image64,angular.element(".modal svg").attr("style","display:none"),$(".dropdown").hide(),angular.element(".legend-info").attr("style","display:none"),html2canvas(node).then(function(canvas){canvas.toBlob(function(blob){if("undefined"==scope.title||void 0==scope.title){scope.titleH2=$("#"+scope.id).parents().find("h2:eq(0)").text();var filename=scope.titleH2+".png"}else var filename=scope.title+".png";saveAs(blob,filename),$(".dropdown").show(),$("#svg2image").remove(),angular.element(".modal svg").removeAttr("style"),angular.element(".legend-info").removeAttr("style","display:none")})})},exportDataAction:function(scope,dashboard){window._paq.push(["trackEvent",$state.current.name,"Export","CSV"]);var title=scope.title;null==title&&(title="Data"),title=title.replace(/;/g," ").replace(/,/g," ").replace(/ +/g,"_");var exportDefinition={type:"ExportPopupComponent",dataExportAttachmentName:title},component=""+scope.id;exportDefinition.dataExportType="csv",exportDefinition.dataComponent=dashboard.dashboard.getComponentByName(component);var exportComponent=new ExportPopupComponent(exportDefinition);exportComponent.dashboard=dashboard.dashboard;var columns="",numberColumns=exportComponent.dataComponent.chart.metadata.length;for(i=0;i<numberColumns;i++)columns+=exportComponent.dataComponent.chart.metadata[i].colName+";";columns=columns.substring(0,columns.length-1);var data="";for(i=0;i<exportComponent.dataComponent.chart.resultset.length;i++){var dataTMP=exportComponent.dataComponent.chart.resultset[i];for(a=0;a<dataTMP.length;a++){var value=exportComponent.dataComponent.chart.resultset[i][a];!isNaN(value)&&(value<-1||value>-1&&value<0)?data+=Math.abs(value)+";":($.isNumeric(value)&&value%1>0&&(value=Math.ceil(100*value)/100),data+=value+";")}data=data.substring(0,data.length-1)+"\n"}data+="\n\n",data+="NOTE: the figures are in English and uses commas for thousands and dots for decimals.\nIf you have your computer in other language, please go to advanced options in Excel, and change the system separators to view the data properly.",function(){var csv="\ufeff"+columns+"\n"+data,blob=new Blob([csv],{type:"text/csv;charset=UTF-8"});saveAs(blob,title+".csv")}()}}};return ExportService.$inject=["$log","$q","$state"],ExportService});